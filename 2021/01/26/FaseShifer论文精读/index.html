<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="lvskiller's Blog" type="application/atom+xml" />






<meta name="description" content="FaseShifter论文精读 学习论文：FaceShifter: Towards High Fidelity And Occlusion Aware Face Swapping 论文目的：This paper proposes a two-staged method callded FaceShifer to get high quality Face Swap.AEI-net make ful">
<meta property="og:type" content="article">
<meta property="og:title" content="FaseShifer论文精读">
<meta property="og:url" content="http://yoursite.com/2021/01/26/FaseShifer%E8%AE%BA%E6%96%87%E7%B2%BE%E8%AF%BB/index.html">
<meta property="og:site_name" content="lvskiller&#39;s Blog">
<meta property="og:description" content="FaseShifter论文精读 学习论文：FaceShifter: Towards High Fidelity And Occlusion Aware Face Swapping 论文目的：This paper proposes a two-staged method callded FaceShifer to get high quality Face Swap.AEI-net make ful">
<meta property="og:image" content="http://yoursite.com/2021/01/26/FaseShifer%E8%AE%BA%E6%96%87%E7%B2%BE%E8%AF%BB/Structure.png">
<meta property="og:image" content="http://yoursite.com/2021/01/26/FaseShifer%E8%AE%BA%E6%96%87%E7%B2%BE%E8%AF%BB/id.png">
<meta property="og:image" content="http://yoursite.com/2021/01/26/FaseShifer%E8%AE%BA%E6%96%87%E7%B2%BE%E8%AF%BB/attribute.png">
<meta property="og:image" content="http://yoursite.com/2021/01/26/FaseShifer%E8%AE%BA%E6%96%87%E7%B2%BE%E8%AF%BB/reconstruction.png">
<meta property="og:image" content="http://yoursite.com/2021/01/26/FaseShifer%E8%AE%BA%E6%96%87%E7%B2%BE%E8%AF%BB/hinge_loss.png">
<meta property="article:published_time" content="2021-01-26T09:35:45.000Z">
<meta property="article:modified_time" content="2021-02-10T11:59:10.957Z">
<meta property="article:author" content="lvskiller">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yoursite.com/2021/01/26/FaseShifer%E8%AE%BA%E6%96%87%E7%B2%BE%E8%AF%BB/Structure.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>

<script>
(function(){
 if(''){
 if (prompt('请输入文章密码') !== ''){
                 alert('密码错误！');
                                 history.back();
                                             
 }
         
 }
     
 })();
</script>



  <link rel="canonical" href="http://yoursite.com/2021/01/26/FaseShifer论文精读/"/>








  <title>FaseShifer论文精读 | lvskiller's Blog</title>
  








<meta name="generator" content="Hexo 4.2.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">lvskiller's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/01/26/FaseShifer%E8%AE%BA%E6%96%87%E7%B2%BE%E8%AF%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="lvskiller">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lvskiller's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">FaseShifer论文精读</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-01-26T17:35:45+08:00">
                2021-01-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  4k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  18
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="FaseShifter论文精读"><a href="#FaseShifter论文精读" class="headerlink" title="FaseShifter论文精读"></a>FaseShifter论文精读</h1><blockquote>
<p>学习论文：FaceShifter: Towards High Fidelity And Occlusion Aware Face Swapping</p>
<p>论文目的：This paper proposes a two-staged method callded FaceShifer to get high quality Face Swap.AEI-net make full use of the information from the targert image.And Hear-net can explozit the Fidelity and occlusion.</p>
<p>关键词：<strong>Face Swap</strong>   </p>
</blockquote>
<a id="more"></a>
<h3 id="introduction"><a href="#introduction" class="headerlink" title="introduction"></a>introduction</h3><p>换脸这项工作的应用很多，但是发现这个很容易被一个二分类器所区分，所以效果不是很好。一些以前的工作只代替脸部的像素，但是它对于姿势和视角的变化很敏感。而用3D-model来处理它的准确率和鲁棒性都不是很好；所以如何获得真实的和高保真的换脸仍然是个问题。</p>
<p>这里传统会用<strong>alpha or Poisson blending</strong>，可以扩展一下，但是这个只能很好处理pose和exression，但是更多一致性不好：比如: the rendering of the swapped face should be faithful to the lighting (e.g. direction, intensity, color) of the target scene, the pixel resolution of the swapped face should also be consistent with the target image resolution。所以我们需要<em>a thorough and adaptive integration of target image attributes during the synthesis of the swapped face</em></p>
<p>常见的方法就是提取到pose and expression guidances，然后利用目标图片的mask来进行混合，但是这样就很容易人造性：1)只利用了目标图片的少量信息，不能尊重目标图片的光照之类的 2）丢失了太多源图片的信息，只用了源图片的mask附近的信息。比如IPGAN，RSGAN，FSNet等等</p>
<p>接下来就是Hear-Net，这个是用来提取遮挡信息的，将同一张图片作为源和目标图片输入AEI-Net，而生成的图片和源图片的差距就提示着遮罩了。</p>
<h3 id="Related-works"><a href="#Related-works" class="headerlink" title="Related works"></a>Related works</h3><p>这里很急着学代码，等会再写</p>
<h3 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h3><p>文章提出的结构是FaceShiferter，这个分为两个阶段：获得高保真度交换图片的AEI-Net，处理遮挡和精细化的Hear-Net。</p>
<h4 id="AEI-Net"><a href="#AEI-Net" class="headerlink" title="AEI-Net"></a>AEI-Net</h4><h5 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h5><p>这个需要保存源图片的identity和目标图片的attribute。这个又分为3个组成部分：1）Identity Encoder 2）Multi-level Attributes Encoder 3）Adaptive Attentional Denormalization Generator</p>
<ol>
<li><p>Identity Encoder :我们用当前最先进的识别模型作为提取特征的模型，去掉了最后的Fc，同时我们相信这个比3DMM模型提取更多消息。</p>
</li>
<li><p>Multi-level Attributes Encoder：这里用了一个U-Net类似的模型来多尺度提取信息，但是这里是要靠训练的，最后提取的信息为：$z_{att}(Xt) = \{z1_{att(}Xt), z2_{att}(Xt), ···,zn_{att}(Xt)\}  $,</p>
</li>
<li><p>Adaptive Attentional Denormalization Generator:这是最重要的模块。</p>
<p><img src="/2021/01/26/FaseShifer%E8%AE%BA%E6%96%87%E7%B2%BE%E8%AF%BB/Structure.png" style="zoom:200%;"></p>
</li>
</ol>
<p>这就是他的构成模块，最重要的当然是这个ADD，这里将h和$z_{att}$和$z_{id}$合成在一起。最开始h进行了一次IN，进行了一次平均，可以当作不存在吧</p>
<p>这里合成分为了三个分支</p>
<ul>
<li>首先介绍M，这是类似一个mask，经过一次卷积直接就得到了<strong>$M^k$</strong></li>
<li>其次再是A，这里有点借鉴了SPADE的做法，$A^k = γ^k_{att} ⊗ h_k + β^k_{att}$，这里的$\gamma$和$\beta$都是从$z_{att}$中训练得到的。同时这里学习到的和$h^k$的大小是一致的，可能就是这样提取信息比较多。</li>
<li>接着就是I，这里和上面A几乎一致，$I^k = γ^k_{id}⊗h_k + β^k_{id}$，这里就获得了I，但是这里区别一点，这里的$\gamma$和$\beta$是1Dvector</li>
<li>最后将这些合成，$h^k_{out} = (1 − M^k ) ⊗ A^k + M^k⊗ I^k$</li>
</ul>
<p>总体结构也如a一样。</p>
<h5 id="loss"><a href="#loss" class="headerlink" title="loss"></a>loss</h5><p>接下来就是loss了：</p>
<ol>
<li><p>最简单就是adversarial loss，这是使得尽可能真实的。</p>
</li>
<li><p>identity loss，显而易见，只不过这里用的是余弦相似度。这里就不是很想解释                                                 <img src="/2021/01/26/FaseShifer%E8%AE%BA%E6%96%87%E7%B2%BE%E8%AF%BB/id.png" alt></p>
</li>
<li><p>接下来是attribute ，这里也蛮明显的。</p>
<p><img src="/2021/01/26/FaseShifer%E8%AE%BA%E6%96%87%E7%B2%BE%E8%AF%BB/attribute.png" alt></p>
</li>
<li><p>接下来就是reconstruction loss，这个loss也蛮常见的，他这是只在目标和源一致的情况下才计算的。</p>
</li>
</ol>
<p><img src="/2021/01/26/FaseShifer%E8%AE%BA%E6%96%87%E7%B2%BE%E8%AF%BB/reconstruction.png" alt></p>
<p>这几个loss都不需要赘述，直接看就好了。</p>
<h3 id="代码解读"><a href="#代码解读" class="headerlink" title="代码解读"></a>代码解读</h3><p>太想直接看代码了</p>
<p>啊啊啊</p>
<h4 id="AAD模块"><a href="#AAD模块" class="headerlink" title="AAD模块"></a>AAD模块</h4><p>首先直接看AAD那块模块，这里要介绍一下pytorch的乘法了，一般*就是按照元素乘，矩阵乘需要mm或者@，更多思考见 <a href="https://blog.csdn.net/qimo601/article/details/112314169" target="_blank" rel="noopener">别人的博客</a></p>
<p>还有就是pytorch也存在广播机制，但是这些扩展啥的有些麻烦，而且难以控制，所以论文使用了expand_as来控制。tensor.expand和tensor.expand_as 功能大致相同，但是前者参数是具体数值大小，而后者则是其他tensor.广播这个写法我很喜欢，<code>gamma_id.reshape(h.shape[0], self.c_x, 1, 1).expand_as(h)</code>我可能会写错一些东西，但是论文写的很好。(有时候我会思考reshape的变换方式，但是其实没必要多余思考，它做的reshape就是你最理想的事情)。</p>
<p>这里区分一下torch.sigmoid和torch.nn.sigmoid的区别，功能是一致的，但是前者是function，后者是class（layer），参数调用也不一样。</p>
<p>还有一个小细节，就是.to(M.device)，这里虽然我不知道不加是不是有啥后果，但是声明的多余变量应该把他放到其他device去，直接声明的可能是在cpu上。</p>
<p>这里的torch.ones_like和torch.ones想必我无须多区别了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### 这里有个假设前提，就是这个attr_c 和c_x的H W要一致，不然点乘不一致</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AADLayer</span><span class="params">(nn.Module)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, c_x, attr_c, c_id=<span class="number">256</span>)</span>:</span></span><br><span class="line">        super(AADLayer, self).__init__()</span><br><span class="line">        self.attr_c = attr_c</span><br><span class="line">        self.c_id = c_id</span><br><span class="line">        self.c_x = c_x</span><br><span class="line"></span><br><span class="line">        self.conv1 = nn.Conv2d(attr_c, c_x, kernel_size=<span class="number">1</span>, stride=<span class="number">1</span>, padding=<span class="number">0</span>, bias=<span class="literal">True</span>)</span><br><span class="line">        self.conv2 = nn.Conv2d(attr_c, c_x, kernel_size=<span class="number">1</span>, stride=<span class="number">1</span>, padding=<span class="number">0</span>, bias=<span class="literal">True</span>)</span><br><span class="line">        self.fc1 = nn.Linear(c_id, c_x)</span><br><span class="line">        self.fc2 = nn.Linear(c_id, c_x)</span><br><span class="line">        self.norm = nn.InstanceNorm2d(c_x, affine=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">        self.conv_h = nn.Conv2d(c_x, <span class="number">1</span>, kernel_size=<span class="number">1</span>, stride=<span class="number">1</span>, padding=<span class="number">0</span>, bias=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, h_in, z_attr, z_id)</span>:</span></span><br><span class="line">        <span class="comment"># h_in cxnxn</span></span><br><span class="line">        <span class="comment"># zid 256x1x1</span></span><br><span class="line">        <span class="comment"># zattr cxnxn</span></span><br><span class="line">        h = self.norm(h_in)</span><br><span class="line">        gamma_attr = self.conv1(z_attr)</span><br><span class="line">        beta_attr = self.conv2(z_attr)</span><br><span class="line"></span><br><span class="line">        gamma_id = self.fc1(z_id)</span><br><span class="line">        beta_id = self.fc2(z_id)</span><br><span class="line">        A = gamma_attr * h + beta_attr</span><br><span class="line">        gamma_id = gamma_id.reshape(h.shape[<span class="number">0</span>], self.c_x, <span class="number">1</span>, <span class="number">1</span>).expand_as(h)</span><br><span class="line">        beta_id = beta_id.reshape(h.shape[<span class="number">0</span>], self.c_x, <span class="number">1</span>, <span class="number">1</span>).expand_as(h)</span><br><span class="line">        I = gamma_id * h + beta_id</span><br><span class="line"></span><br><span class="line">        M = torch.sigmoid(self.conv_h(h))</span><br><span class="line"></span><br><span class="line">        out = (torch.ones_like(M).to(M.device) - M) * A + M * I</span><br><span class="line">        <span class="keyword">return</span> out</span><br></pre></td></tr></table></figure>
<h4 id="AAD-ResBlock"><a href="#AAD-ResBlock" class="headerlink" title="AAD ResBlock"></a>AAD ResBlock</h4><p>首先就是介绍一下nn.ReLU(inplace=True)这个参数就是覆盖参数的作用，就是不用再重新新建对象，覆盖了原有对象了，所以节约了内存。</p>
<p>这里的操作也是just so so，只不过他写的顺序有点小奇怪，不过结果是一致的。</p>
<p>这里注意到一个细节就是bias是否被添加，答案是如果后面又BN就不要bias，因为BN的操作会使得bias没有任何意义，只会浪费内存。</p>
<p>这里和论文还有不同的地方，就是原文只有两个AAD，但是这里新添加channel不同的地方，所以在后面又加了一个AAD，不过都是小问题,不对，在附录里面写的清清楚楚就是应该这样。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AAD_ResBlk</span><span class="params">(nn.Module)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, cin, cout, c_attr, c_id=<span class="number">256</span>)</span>:</span></span><br><span class="line">        super(AAD_ResBlk, self).__init__()</span><br><span class="line">        self.cin = cin</span><br><span class="line">        self.cout = cout</span><br><span class="line"></span><br><span class="line">        self.AAD1 = AADLayer(cin, c_attr, c_id)</span><br><span class="line">        self.conv1 = nn.Conv2d(cin, cin, kernel_size=<span class="number">3</span>, stride=<span class="number">1</span>, padding=<span class="number">1</span>, bias=<span class="literal">False</span>)</span><br><span class="line">        self.relu1 = nn.ReLU(inplace=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">        self.AAD2 = AADLayer(cin, c_attr, c_id)</span><br><span class="line">        self.conv2 = nn.Conv2d(cin, cout, kernel_size=<span class="number">3</span>, stride=<span class="number">1</span>, padding=<span class="number">1</span>, bias=<span class="literal">False</span>)</span><br><span class="line">        self.relu2 = nn.ReLU(inplace=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> cin != cout:</span><br><span class="line">            self.AAD3 = AADLayer(cin, c_attr, c_id)</span><br><span class="line">            self.conv3 = nn.Conv2d(cin, cout, kernel_size=<span class="number">3</span>, stride=<span class="number">1</span>, padding=<span class="number">1</span>, bias=<span class="literal">False</span>)</span><br><span class="line">            self.relu3 = nn.ReLU(inplace=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, h, z_attr, z_id)</span>:</span></span><br><span class="line">        x = self.AAD1(h, z_attr, z_id)</span><br><span class="line">        x = self.relu1(x)</span><br><span class="line">        x = self.conv1(x)</span><br><span class="line"></span><br><span class="line">        x = self.AAD2(x,z_attr, z_id)</span><br><span class="line">        x = self.relu2(x)</span><br><span class="line">        x = self.conv2(x)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.cin != self.cout:</span><br><span class="line">            h = self.AAD3(h, z_attr, z_id)</span><br><span class="line">            h = self.relu3(h)</span><br><span class="line">            h = self.conv3(h)</span><br><span class="line">        x = x + h</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> x</span><br></pre></td></tr></table></figure>
<h4 id="小块"><a href="#小块" class="headerlink" title="小块"></a>小块</h4><p>首先为啥又conv和deconv呢，这个原因很简单,还记得U-Net吗？这就是U-Net的原因。</p>
<p>conv和deconv是两种不同的写法，主要原因是deconv的写法问题，增加了一个skip层，这里和上个版本不是很一致，这个直接再deconv里动手脚，将deconv里就将skip加上了。</p>
<p>第一个conv4x4返回一个nn.Sequential就很简单做，比ModuleList方便多了。</p>
<p>第二个deconv就多了一个torch.cat操作。</p>
<p>不由感叹卷积只要考虑深度就好了，HW这些事只要算阶段就好了，甚至不用算。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">def conv4x4(in_c, out_c, norm&#x3D;nn.BatchNorm2d):</span><br><span class="line">    return nn.Sequential(</span><br><span class="line">        nn.Conv2d(in_channels&#x3D;in_c, out_channels&#x3D;out_c, kernel_size&#x3D;4, stride&#x3D;2, padding&#x3D;1, bias&#x3D;False),</span><br><span class="line">        norm(out_c),</span><br><span class="line">        nn.LeakyReLU(0.1, inplace&#x3D;True)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class deconv4x4(nn.Module):</span><br><span class="line">    def __init__(self, in_c, out_c, norm&#x3D;nn.BatchNorm2d):</span><br><span class="line">        super(deconv4x4, self).__init__()</span><br><span class="line">        self.deconv &#x3D; nn.ConvTranspose2d(in_channels&#x3D;in_c, out_channels&#x3D;out_c, kernel_size&#x3D;4, stride&#x3D;2, padding&#x3D;1, bias&#x3D;False)</span><br><span class="line">        self.bn &#x3D; norm(out_c)</span><br><span class="line">        self.lrelu &#x3D; nn.LeakyReLU(0.1, inplace&#x3D;True)</span><br><span class="line"></span><br><span class="line">    def forward(self, input, skip):</span><br><span class="line">        x &#x3D; self.deconv(input)</span><br><span class="line">        x &#x3D; self.bn(x)</span><br><span class="line">        x &#x3D; self.lrelu(x)</span><br><span class="line">        return torch.cat((x, skip), dim&#x3D;1)</span><br></pre></td></tr></table></figure>
<h4 id="MLAttrEncoder"><a href="#MLAttrEncoder" class="headerlink" title="MLAttrEncoder"></a>MLAttrEncoder</h4><p>首先介绍python的多返回值的这件事，返回的时侯看上去不是一个元组，但是它会自动的序列化成元组，同时你也可以用返回值去接他，自动反序列化。</p>
<p>然后稍微说一下 F.interpolate，这个就类似以前的nn.sample，我看别人在U-Net就是这么干的，这里最后一个参数align_corners (bool, optional): 如果 align_corners=True，则对齐 input 和 output 的角点像素(corner pixels)，保持在角点像素的值. 只会对 mode=linear, bilinear 和 trilinear 有作用. 默认是 False.其实和nn.UpSample没有啥区别。</p>
<p>其他结构就和以前解读一模一样。</p>
<p>这里还多一个apply函数 ，简单来说就是对自己这个函数的成员递归调用函数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">weight_init</span><span class="params">(m)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> isinstance(m, nn.Linear):</span><br><span class="line">        m.weight.data.normal_(<span class="number">0</span>, <span class="number">0.001</span>)</span><br><span class="line">        m.bias.data.zero_()</span><br><span class="line">    <span class="keyword">if</span> isinstance(m, nn.Conv2d):</span><br><span class="line">        nn.init.xavier_normal_(m.weight.data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> isinstance(m, nn.ConvTranspose2d):</span><br><span class="line">        nn.init.xavier_normal_(m.weight.data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MLAttrEncoder</span><span class="params">(nn.Module)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        super(MLAttrEncoder, self).__init__()</span><br><span class="line">        self.conv1 = conv4x4(<span class="number">3</span>, <span class="number">32</span>)</span><br><span class="line">        self.conv2 = conv4x4(<span class="number">32</span>, <span class="number">64</span>)</span><br><span class="line">        self.conv3 = conv4x4(<span class="number">64</span>, <span class="number">128</span>)</span><br><span class="line">        self.conv4 = conv4x4(<span class="number">128</span>, <span class="number">256</span>)</span><br><span class="line">        self.conv5 = conv4x4(<span class="number">256</span>, <span class="number">512</span>)</span><br><span class="line">        self.conv6 = conv4x4(<span class="number">512</span>, <span class="number">1024</span>)</span><br><span class="line">        self.conv7 = conv4x4(<span class="number">1024</span>, <span class="number">1024</span>)</span><br><span class="line"></span><br><span class="line">        self.deconv1 = deconv4x4(<span class="number">1024</span>, <span class="number">1024</span>)</span><br><span class="line">        self.deconv2 = deconv4x4(<span class="number">2048</span>, <span class="number">512</span>)</span><br><span class="line">        self.deconv3 = deconv4x4(<span class="number">1024</span>, <span class="number">256</span>)</span><br><span class="line">        self.deconv4 = deconv4x4(<span class="number">512</span>, <span class="number">128</span>)</span><br><span class="line">        self.deconv5 = deconv4x4(<span class="number">256</span>, <span class="number">64</span>)</span><br><span class="line">        self.deconv6 = deconv4x4(<span class="number">128</span>, <span class="number">32</span>)</span><br><span class="line"></span><br><span class="line">        self.apply(weight_init)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, Xt)</span>:</span></span><br><span class="line">        feat1 = self.conv1(Xt)</span><br><span class="line">        <span class="comment"># 32x128x128</span></span><br><span class="line">        feat2 = self.conv2(feat1)</span><br><span class="line">        <span class="comment"># 64x64x64</span></span><br><span class="line">        feat3 = self.conv3(feat2)</span><br><span class="line">        <span class="comment"># 128x32x32</span></span><br><span class="line">        feat4 = self.conv4(feat3)</span><br><span class="line">        <span class="comment"># 256x16xx16</span></span><br><span class="line">        feat5 = self.conv5(feat4)</span><br><span class="line">        <span class="comment"># 512x8x8</span></span><br><span class="line">        feat6 = self.conv6(feat5)</span><br><span class="line">        <span class="comment"># 1024x4x4</span></span><br><span class="line">        z_attr1 = self.conv7(feat6)</span><br><span class="line">        <span class="comment"># 1024x2x2</span></span><br><span class="line"></span><br><span class="line">        z_attr2 = self.deconv1(z_attr1, feat6)</span><br><span class="line">        z_attr3 = self.deconv2(z_attr2, feat5)</span><br><span class="line">        z_attr4 = self.deconv3(z_attr3, feat4)</span><br><span class="line">        z_attr5 = self.deconv4(z_attr4, feat3)</span><br><span class="line">        z_attr6 = self.deconv5(z_attr5, feat2)</span><br><span class="line">        z_attr7 = self.deconv6(z_attr6, feat1)</span><br><span class="line">        z_attr8 = F.interpolate(z_attr7, scale_factor=<span class="number">2</span>, mode=<span class="string">'bilinear'</span>, align_corners=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> z_attr1, z_attr2, z_attr3, z_attr4, z_attr5, z_attr6, z_attr7, z_attr8</span><br></pre></td></tr></table></figure>
<h4 id="AADGenerator"><a href="#AADGenerator" class="headerlink" title="AADGenerator"></a>AADGenerator</h4><p>啊啊啊啊，附录永远的神，我个小垃圾，一直没看过附录，难怪自己看得欲仙欲死。</p>
<p>首先将$z_{id}$   deconv 作为原处的输入，这里高度精炼的写法，最后的upsample直接用 F.interpolate取代成一行，压缩了很多代码，完成了很重要的内容。</p>
<p>output = (input-1)stride+outputpadding -2padding+kernelsize，</p>
<p>最后一个tanh我其实在原论文没有看到。。。，这也为后续的还原埋下了伏笔。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AADGenerator</span><span class="params">(nn.Module)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, c_id=<span class="number">256</span>)</span>:</span></span><br><span class="line">        super(AADGenerator, self).__init__()</span><br><span class="line">        self.up1 = nn.ConvTranspose2d(c_id, <span class="number">1024</span>, kernel_size=<span class="number">2</span>, stride=<span class="number">1</span>, padding=<span class="number">0</span>)</span><br><span class="line">        self.AADBlk1 = AAD_ResBlk(<span class="number">1024</span>, <span class="number">1024</span>, <span class="number">1024</span>, c_id)</span><br><span class="line">        self.AADBlk2 = AAD_ResBlk(<span class="number">1024</span>, <span class="number">1024</span>, <span class="number">2048</span>, c_id)</span><br><span class="line">        self.AADBlk3 = AAD_ResBlk(<span class="number">1024</span>, <span class="number">1024</span>, <span class="number">1024</span>, c_id)</span><br><span class="line">        self.AADBlk4 = AAD_ResBlk(<span class="number">1024</span>, <span class="number">512</span>, <span class="number">512</span>, c_id)</span><br><span class="line">        self.AADBlk5 = AAD_ResBlk(<span class="number">512</span>, <span class="number">256</span>, <span class="number">256</span>, c_id)</span><br><span class="line">        self.AADBlk6 = AAD_ResBlk(<span class="number">256</span>, <span class="number">128</span>, <span class="number">128</span>, c_id)</span><br><span class="line">        self.AADBlk7 = AAD_ResBlk(<span class="number">128</span>, <span class="number">64</span>, <span class="number">64</span>, c_id)</span><br><span class="line">        self.AADBlk8 = AAD_ResBlk(<span class="number">64</span>, <span class="number">3</span>, <span class="number">64</span>, c_id)</span><br><span class="line"></span><br><span class="line">        self.apply(weight_init)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, z_attr, z_id)</span>:</span></span><br><span class="line">        m = self.up1(z_id.reshape(z_id.shape[<span class="number">0</span>], <span class="number">-1</span>, <span class="number">1</span>, <span class="number">1</span>))</span><br><span class="line">        m2 = F.interpolate(self.AADBlk1(m, z_attr[<span class="number">0</span>], z_id), scale_factor=<span class="number">2</span>, mode=<span class="string">'bilinear'</span>, align_corners=<span class="literal">True</span>)</span><br><span class="line">        m3 = F.interpolate(self.AADBlk2(m2, z_attr[<span class="number">1</span>], z_id), scale_factor=<span class="number">2</span>, mode=<span class="string">'bilinear'</span>, align_corners=<span class="literal">True</span>)</span><br><span class="line">        m4 = F.interpolate(self.AADBlk3(m3, z_attr[<span class="number">2</span>], z_id), scale_factor=<span class="number">2</span>, mode=<span class="string">'bilinear'</span>, align_corners=<span class="literal">True</span>)</span><br><span class="line">        m5 = F.interpolate(self.AADBlk4(m4, z_attr[<span class="number">3</span>], z_id), scale_factor=<span class="number">2</span>, mode=<span class="string">'bilinear'</span>, align_corners=<span class="literal">True</span>)</span><br><span class="line">        m6 = F.interpolate(self.AADBlk5(m5, z_attr[<span class="number">4</span>], z_id), scale_factor=<span class="number">2</span>, mode=<span class="string">'bilinear'</span>, align_corners=<span class="literal">True</span>)</span><br><span class="line">        m7 = F.interpolate(self.AADBlk6(m6, z_attr[<span class="number">5</span>], z_id), scale_factor=<span class="number">2</span>, mode=<span class="string">'bilinear'</span>, align_corners=<span class="literal">True</span>)</span><br><span class="line">        m8 = F.interpolate(self.AADBlk7(m7, z_attr[<span class="number">6</span>], z_id), scale_factor=<span class="number">2</span>, mode=<span class="string">'bilinear'</span>, align_corners=<span class="literal">True</span>)</span><br><span class="line">        y = self.AADBlk8(m8, z_attr[<span class="number">7</span>], z_id)</span><br><span class="line">        <span class="keyword">return</span> torch.tanh(y)</span><br></pre></td></tr></table></figure>
<h4 id="AEI-Net-1"><a href="#AEI-Net-1" class="headerlink" title="AEI_Net"></a>AEI_Net</h4><p>这里其实简单的，就是联合起来而已哦</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AEI_Net</span><span class="params">(nn.Module)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, c_id=<span class="number">256</span>)</span>:</span></span><br><span class="line">        super(AEI_Net, self).__init__()</span><br><span class="line">        self.encoder = MLAttrEncoder()</span><br><span class="line">        self.generator = AADGenerator(c_id)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">forward</span><span class="params">(self, Xt, z_id)</span>:</span></span><br><span class="line">        attr = self.encoder(Xt)</span><br><span class="line">        Y = self.generator(attr, z_id)</span><br><span class="line">        <span class="keyword">return</span> Y, attr</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_attr</span><span class="params">(self, X)</span>:</span></span><br><span class="line">        <span class="comment"># with torch.no_grad():</span></span><br><span class="line">        <span class="keyword">return</span> self.encoder(X)</span><br></pre></td></tr></table></figure>
<p>至此,AEI-Net就完美的实现了，太厉害了呢，而我要做的工作也正式基于此来做的，我大致再读一下整体的流程。</p>
<h4 id="整体流程"><a href="#整体流程" class="headerlink" title="整体流程"></a>整体流程</h4><p>提一下torch.backends.cudnn.benchmark，这个在博客中 <a href="https://blog.csdn.net/byron123456sfsfsfa/article/details/96003317" target="_blank" rel="noopener">相关理解</a>，主要是进行卷积层加速的（适合静态网络）</p>
<p>这里稍微说一下torch.load_state_dict的理解，这里主要是map_location的区别了，这是在cpu和gpu转换的关键，可以去这个博客去看看<a href="https://www.cnblogs.com/xiaodai0/p/10413711.html" target="_blank" rel="noopener">理解地址</a></p>
<p>另外提一下apex这个工具，apex是一个很强大的东西，主要是用来进行模型加速的，试验表明FP16精度就可以达到FP32的效果，而这个工具就是用来混合精度训练的东西。这是百度和英伟达联合推出的一篇论文，主要就是加快训练速度的，首先要将网络结构大部分用F16储存，但是权重会用FP32备份一下（避免舍入误差）；然后要进行梯度的放大，在梯度更新是再变为FP32（避免梯度下溢置零）。用代码体现为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">G, opt_G = amp.initialize(G, opt_G, opt_level=optim_level)</span><br><span class="line">D, opt_D = amp.initialize(D, opt_D, opt_level=optim_level)</span><br><span class="line"><span class="keyword">with</span> amp.scale_loss(lossD, opt_D) <span class="keyword">as</span> scaled_loss:</span><br><span class="line">	scaled_loss.backward()</span><br></pre></td></tr></table></figure>
<p>我对原论文的几个loss也很感兴趣</p>
<ol>
<li><p>首先是adversail loss,显然这里是用了多个D做鉴别，至于为啥不是常见的那种交叉熵呢，因为其他论文已经证明这个hinge loss是可以代替的，且训练速度更加快。具体函数如，当然我觉得这个G不好。</p>
<p><img src="/2021/01/26/FaseShifer%E8%AE%BA%E6%96%87%E7%B2%BE%E8%AF%BB/hinge_loss.png" alt></p>
<p>这里还有detach的一个问题，我知道这是从计算图里摘出来，但是为什么要摘出来就不理解。D这里其实可以不摘出来，因为两者是不同的优化器，不会出现超出范围的优化，但是摘出来有助于加快速度。G这里摘出来就阻断了回传，罪大恶极。</p>
<p><a href="https://blog.csdn.net/superjunenaruto/article/details/99942241" target="_blank" rel="noopener">理解地址</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hinge_loss</span><span class="params">(X, positive=True)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> positive:</span><br><span class="line">        <span class="keyword">return</span> torch.relu(<span class="number">1</span>-X).mean()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> torch.relu(X+<span class="number">1</span>).mean()</span><br><span class="line">Di = D(Y)</span><br><span class="line">L_adv = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> di <span class="keyword">in</span> Di:</span><br><span class="line">	L_adv += hinge_loss(di[<span class="number">0</span>], <span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">fake_D = D(Y.detach())</span><br><span class="line">loss_fake = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> di <span class="keyword">in</span> fake_D:</span><br><span class="line">    loss_fake += hinge_loss(di[<span class="number">0</span>], <span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">true_D = D(Xs)</span><br><span class="line">loss_true = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> di <span class="keyword">in</span> true_D:</span><br><span class="line">    loss_true += hinge_loss(di[<span class="number">0</span>], <span class="literal">True</span>)</span><br><span class="line">lossD = <span class="number">0.5</span>*(loss_true.mean() + loss_fake.mean())</span><br></pre></td></tr></table></figure>
<ol>
<li>id_loss,这里用的是余弦相似度，返回参数大小也很好理解</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">L_id =(<span class="number">1</span> - torch.cosine_similarity(embed, ZY, dim=<span class="number">1</span>)).mean()</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>​         3. attribute loss:这里就很简单的l2距离,为啥要两次mean，瞄一下就知道了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Y_attr = G.get_attr(Y)</span><br><span class="line">L_attr = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(Xt_attr)):</span><br><span class="line">    L_attr += torch.mean(torch.pow(Xt_attr[i] - Y_attr[i], <span class="number">2</span>).reshape(batch_size, <span class="number">-1</span>),       dim=<span class="number">1</span>).mean()</span><br><span class="line">L_attr /= <span class="number">2.0</span></span><br></pre></td></tr></table></figure>
<ol>
<li><p>reconstruction loss ,这里关键点在于same_person,如果相同就不用算了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">L_rec = torch.sum(<span class="number">0.5</span> * torch.mean(torch.pow(Y - Xt, <span class="number">2</span>).reshape(batch_size, <span class="number">-1</span>), dim=<span class="number">1</span>) * same_person) / (same_person.sum() + <span class="number">1e-6</span>)</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>好像这是之后也没啥好说的整体流程了，接下来就是改进的工作了。</p>
<h4 id="改进流程"><a href="#改进流程" class="headerlink" title="改进流程"></a>改进流程</h4><p>首先是features的大小</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">24</span></span><br><span class="line">torch.Size([<span class="number">4</span>, <span class="number">64</span>, <span class="number">56</span>, <span class="number">56</span>])</span><br><span class="line">torch.Size([<span class="number">4</span>, <span class="number">64</span>, <span class="number">56</span>, <span class="number">56</span>])</span><br><span class="line">torch.Size([<span class="number">4</span>, <span class="number">64</span>, <span class="number">56</span>, <span class="number">56</span>])</span><br><span class="line">torch.Size([<span class="number">4</span>, <span class="number">128</span>, <span class="number">28</span>, <span class="number">28</span>])</span><br><span class="line">torch.Size([<span class="number">4</span>, <span class="number">128</span>, <span class="number">28</span>, <span class="number">28</span>])</span><br><span class="line">torch.Size([<span class="number">4</span>, <span class="number">128</span>, <span class="number">28</span>, <span class="number">28</span>])</span><br><span class="line">torch.Size([<span class="number">4</span>, <span class="number">128</span>, <span class="number">28</span>, <span class="number">28</span>])</span><br><span class="line">torch.Size([<span class="number">4</span>, <span class="number">256</span>, <span class="number">14</span>, <span class="number">14</span>])</span><br><span class="line">torch.Size([<span class="number">4</span>, <span class="number">256</span>, <span class="number">14</span>, <span class="number">14</span>])</span><br><span class="line">torch.Size([<span class="number">4</span>, <span class="number">256</span>, <span class="number">14</span>, <span class="number">14</span>])</span><br><span class="line">torch.Size([<span class="number">4</span>, <span class="number">256</span>, <span class="number">14</span>, <span class="number">14</span>])</span><br><span class="line">torch.Size([<span class="number">4</span>, <span class="number">256</span>, <span class="number">14</span>, <span class="number">14</span>])</span><br><span class="line">torch.Size([<span class="number">4</span>, <span class="number">256</span>, <span class="number">14</span>, <span class="number">14</span>])</span><br><span class="line">torch.Size([<span class="number">4</span>, <span class="number">256</span>, <span class="number">14</span>, <span class="number">14</span>])</span><br><span class="line">torch.Size([<span class="number">4</span>, <span class="number">256</span>, <span class="number">14</span>, <span class="number">14</span>])</span><br><span class="line">torch.Size([<span class="number">4</span>, <span class="number">256</span>, <span class="number">14</span>, <span class="number">14</span>])</span><br><span class="line">torch.Size([<span class="number">4</span>, <span class="number">256</span>, <span class="number">14</span>, <span class="number">14</span>])</span><br><span class="line">torch.Size([<span class="number">4</span>, <span class="number">256</span>, <span class="number">14</span>, <span class="number">14</span>])</span><br><span class="line">torch.Size([<span class="number">4</span>, <span class="number">256</span>, <span class="number">14</span>, <span class="number">14</span>])</span><br><span class="line">torch.Size([<span class="number">4</span>, <span class="number">256</span>, <span class="number">14</span>, <span class="number">14</span>])</span><br><span class="line">torch.Size([<span class="number">4</span>, <span class="number">256</span>, <span class="number">14</span>, <span class="number">14</span>])</span><br><span class="line">torch.Size([<span class="number">4</span>, <span class="number">512</span>, <span class="number">7</span>, <span class="number">7</span>])</span><br><span class="line">torch.Size([<span class="number">4</span>, <span class="number">512</span>, <span class="number">7</span>, <span class="number">7</span>])</span><br><span class="line">torch.Size([<span class="number">4</span>, <span class="number">512</span>, <span class="number">7</span>, <span class="number">7</span>])</span><br></pre></td></tr></table></figure>
<p>如果要操作，我觉得可以考虑和原文不一样的操作，attr和id都是用3D vector，原文中id则是1D vector.</p>
<p>我看一下，attr的大小</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">torch.Size([<span class="number">4</span>, <span class="number">1024</span>, <span class="number">2</span>, <span class="number">2</span>])</span><br><span class="line">torch.Size([<span class="number">4</span>, <span class="number">2048</span>, <span class="number">4</span>, <span class="number">4</span>])</span><br><span class="line">torch.Size([<span class="number">4</span>, <span class="number">1024</span>, <span class="number">8</span>, <span class="number">8</span>])</span><br><span class="line">torch.Size([<span class="number">4</span>, <span class="number">512</span>, <span class="number">16</span>, <span class="number">16</span>])</span><br><span class="line">torch.Size([<span class="number">4</span>, <span class="number">256</span>, <span class="number">32</span>, <span class="number">32</span>])</span><br><span class="line">torch.Size([<span class="number">4</span>, <span class="number">128</span>, <span class="number">64</span>, <span class="number">64</span>])</span><br><span class="line">torch.Size([<span class="number">4</span>, <span class="number">64</span>, <span class="number">128</span>, <span class="number">128</span>])</span><br><span class="line">torch.Size([<span class="number">4</span>, <span class="number">64</span>, <span class="number">256</span>, <span class="number">256</span>])</span><br></pre></td></tr></table></figure>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/01/24/Perceptual-Losses/" rel="next" title="Perceptual-Losses">
                <i class="fa fa-chevron-left"></i> Perceptual-Losses
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2021/01/30/Javax%E5%88%9D%E5%AD%A6/" rel="prev" title="Javax初学">
                Javax初学 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpg"
                alt="lvskiller" />
            
              <p class="site-author-name" itemprop="name">lvskiller</p>
              <p class="site-description motion-element" itemprop="description">生命有无限的可能</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">41</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/lvskiller" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#FaseShifter论文精读"><span class="nav-text">FaseShifter论文精读</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#introduction"><span class="nav-text">introduction</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Related-works"><span class="nav-text">Related works</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#正文"><span class="nav-text">正文</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#AEI-Net"><span class="nav-text">AEI-Net</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#流程"><span class="nav-text">流程</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#loss"><span class="nav-text">loss</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#代码解读"><span class="nav-text">代码解读</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#AAD模块"><span class="nav-text">AAD模块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#AAD-ResBlock"><span class="nav-text">AAD ResBlock</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#小块"><span class="nav-text">小块</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#MLAttrEncoder"><span class="nav-text">MLAttrEncoder</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#AADGenerator"><span class="nav-text">AADGenerator</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#AEI-Net-1"><span class="nav-text">AEI_Net</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#整体流程"><span class="nav-text">整体流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#改进流程"><span class="nav-text">改进流程</span></a></li></ol></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">lvskiller</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">44.9k</span>
  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

</body>
</html>
